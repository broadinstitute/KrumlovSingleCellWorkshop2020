<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Data Wrangling scRNAseq | ANALYSIS OF SINGLE CELL RNA-SEQ DATA</title>
  <meta name="description" content="4 Data Wrangling scRNAseq | ANALYSIS OF SINGLE CELL RNA-SEQ DATA" />
  <meta name="generator" content="bookdown 0.14 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Data Wrangling scRNAseq | ANALYSIS OF SINGLE CELL RNA-SEQ DATA" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://broadinstitute.github.io/KrumlovSingleCellWorkship2020/" />
  <meta property="og:image" content="https://broadinstitute.github.io/KrumlovSingleCellWorkship2020/images/cover.png" />
  
  <meta name="github-repo" content="broadinstitute/KrumlovSingleCellWorkship2020" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Data Wrangling scRNAseq | ANALYSIS OF SINGLE CELL RNA-SEQ DATA" />
  
  
  <meta name="twitter:image" content="https://broadinstitute.github.io/KrumlovSingleCellWorkship2020/images/cover.png" />

<meta name="author" content="Kirk Gosik" />


<meta name="date" content="2020-01-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="expression-qc-and-normalization-1.html"/>
<link rel="next" href="identifying-cell-populations-1.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">ANALYSIS OF SINGLE CELL RNA-SEQ DATA</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#course-overview"><i class="fa fa-check"></i><b>1.1</b> COURSE OVERVIEW</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#targeted-audience-assumed-background"><i class="fa fa-check"></i><b>1.2</b> TARGETED AUDIENCE &amp; ASSUMED BACKGROUND</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#course-format"><i class="fa fa-check"></i><b>1.3</b> COURSE FORMAT</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#getting-started"><i class="fa fa-check"></i><b>1.4</b> Getting Started</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#session-content"><i class="fa fa-check"></i><b>1.5</b> SESSION CONTENT</a><ul>
<li class="chapter" data-level="1.5.1" data-path="index.html"><a href="index.html#introduction-1"><i class="fa fa-check"></i><b>1.5.1</b> Introduction</a></li>
<li class="chapter" data-level="1.5.2" data-path="index.html"><a href="index.html#transcriptome-quantification"><i class="fa fa-check"></i><b>1.5.2</b> Transcriptome Quantification</a></li>
<li class="chapter" data-level="1.5.3" data-path="index.html"><a href="index.html#expression-qc-and-normalization"><i class="fa fa-check"></i><b>1.5.3</b> Expression QC and Normalization</a></li>
<li class="chapter" data-level="1.5.4" data-path="index.html"><a href="index.html#data-wrangling-scrnaseq"><i class="fa fa-check"></i><b>1.5.4</b> Data Wrangling scRNAseq</a></li>
<li class="chapter" data-level="1.5.5" data-path="index.html"><a href="index.html#identifying-cell-populations"><i class="fa fa-check"></i><b>1.5.5</b> Identifying Cell Populations</a></li>
<li class="chapter" data-level="1.5.6" data-path="index.html"><a href="index.html#feature-selection-and-cluster-analysis"><i class="fa fa-check"></i><b>1.5.6</b> Feature Selection and Cluster Analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="transcriptome-quantification-1.html"><a href="transcriptome-quantification-1.html"><i class="fa fa-check"></i><b>2</b> Transcriptome Quantification</a></li>
<li class="chapter" data-level="3" data-path="expression-qc-and-normalization-1.html"><a href="expression-qc-and-normalization-1.html"><i class="fa fa-check"></i><b>3</b> Expression QC and Normalization</a></li>
<li class="chapter" data-level="4" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html"><i class="fa fa-check"></i><b>4</b> Data Wrangling scRNAseq</a><ul>
<li class="chapter" data-level="4.1" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#goal"><i class="fa fa-check"></i><b>4.1</b> Goal</a></li>
<li class="chapter" data-level="4.2" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#introduction-2"><i class="fa fa-check"></i><b>4.2</b> Introduction</a><ul>
<li class="chapter" data-level="4.2.1" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#load-necessary-packages"><i class="fa fa-check"></i><b>4.2.1</b> Load necessary packages</a></li>
<li class="chapter" data-level="4.2.2" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#read-in-nsclc-counts-matrix."><i class="fa fa-check"></i><b>4.2.2</b> Read in NSCLC counts matrix.</a></li>
<li class="chapter" data-level="4.2.3" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#lets-examine-the-sparse-counts-matrix"><i class="fa fa-check"></i><b>4.2.3</b> Let’s examine the sparse counts matrix</a></li>
<li class="chapter" data-level="4.2.4" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#how-big-is-the-matrix"><i class="fa fa-check"></i><b>4.2.4</b> How big is the matrix?</a></li>
<li class="chapter" data-level="4.2.5" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#how-much-memory-does-a-sparse-matrix-take-up-relative-to-a-dense-matrix"><i class="fa fa-check"></i><b>4.2.5</b> How much memory does a sparse matrix take up relative to a dense matrix?</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#filtering-low-quality-cells"><i class="fa fa-check"></i><b>4.3</b> Filtering low-quality cells</a><ul>
<li class="chapter" data-level="4.3.1" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#look-at-the-summary-counts-for-genes-and-cells"><i class="fa fa-check"></i><b>4.3.1</b> Look at the summary counts for genes and cells</a></li>
<li class="chapter" data-level="4.3.2" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#plot-cells-ranked-by-their-number-of-detected-genes."><i class="fa fa-check"></i><b>4.3.2</b> Plot cells ranked by their number of detected genes.</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#beginning-with-seurat-httpsatijalab.orgseurat"><i class="fa fa-check"></i><b>4.4</b> Beginning with Seurat: <span>http://satijalab.org/seurat/</span></a><ul>
<li class="chapter" data-level="4.4.1" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#creating-a-seurat-object"><i class="fa fa-check"></i><b>4.4.1</b> Creating a seurat object</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#preprocessing-step-1-filter-out-low-quality-cells"><i class="fa fa-check"></i><b>4.5</b> Preprocessing step 1 : Filter out low-quality cells</a></li>
<li class="chapter" data-level="4.6" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#examine-contents-of-seurat-object"><i class="fa fa-check"></i><b>4.6</b> Examine contents of Seurat object</a><ul>
<li class="chapter" data-level="4.6.1" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#preprocessing-step-2-expression-normalization"><i class="fa fa-check"></i><b>4.6.1</b> Preprocessing step 2 : Expression normalization</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#detection-of-variable-genes-across-the-single-cells"><i class="fa fa-check"></i><b>4.7</b> Detection of variable genes across the single cells</a></li>
<li class="chapter" data-level="4.8" data-path="data-wrangling-scrnaseq-1.html"><a href="data-wrangling-scrnaseq-1.html#gene-set-expression-across-cells"><i class="fa fa-check"></i><b>4.8</b> Gene set expression across cells</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="identifying-cell-populations-1.html"><a href="identifying-cell-populations-1.html"><i class="fa fa-check"></i><b>5</b> Identifying Cell Populations</a><ul>
<li class="chapter" data-level="5.1" data-path="identifying-cell-populations-1.html"><a href="identifying-cell-populations-1.html#google-slides"><i class="fa fa-check"></i><b>5.1</b> Google Slides</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html"><i class="fa fa-check"></i><b>6</b> Feature Selection and Cluster Analysis</a><ul>
<li class="chapter" data-level="6.1" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#abstract"><i class="fa fa-check"></i><b>6.1</b> Abstract</a></li>
<li class="chapter" data-level="6.2" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#seurat-tutorial"><i class="fa fa-check"></i><b>6.2</b> Seurat Tutorial</a><ul>
<li class="chapter" data-level="6.2.1" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#preprocessing-steps"><i class="fa fa-check"></i><b>6.2.1</b> Preprocessing Steps</a></li>
<li class="chapter" data-level="6.2.2" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#start-of-identifying-cell-types"><i class="fa fa-check"></i><b>6.2.2</b> Start of Identifying Cell Types</a></li>
<li class="chapter" data-level="6.2.3" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#run-non-linear-dimensional-reduction-umaptsne"><i class="fa fa-check"></i><b>6.2.3</b> Run non-linear dimensional reduction (UMAP/tSNE)</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#feature-selection"><i class="fa fa-check"></i><b>6.3</b> Feature Selection</a><ul>
<li class="chapter" data-level="6.3.1" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#differential-expression-analysis"><i class="fa fa-check"></i><b>6.3.1</b> Differential Expression Analysis</a></li>
<li class="chapter" data-level="6.3.2" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#dimensionality-reduction"><i class="fa fa-check"></i><b>6.3.2</b> Dimensionality Reduction</a></li>
<li class="chapter" data-level="6.3.3" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#independent-components-analysis-ica"><i class="fa fa-check"></i><b>6.3.3</b> Independent Components Analysis (ICA)</a></li>
<li class="chapter" data-level="6.3.4" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#clustering"><i class="fa fa-check"></i><b>6.3.4</b> Clustering</a></li>
<li class="chapter" data-level="6.3.5" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#check-clusters"><i class="fa fa-check"></i><b>6.3.5</b> Check Clusters</a></li>
<li class="chapter" data-level="6.3.6" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#view-entire-object-structure"><i class="fa fa-check"></i><b>6.3.6</b> View Entire Object Structure</a></li>
<li class="chapter" data-level="6.3.7" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#practice-visualizingembedding"><i class="fa fa-check"></i><b>6.3.7</b> Practice Visualizing/Embedding</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="feature-selection-and-cluster-analysis-1.html"><a href="feature-selection-and-cluster-analysis-1.html#other-options-for-analysis"><i class="fa fa-check"></i><b>6.4</b> Other Options For Analysis</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">ANALYSIS OF SINGLE CELL RNA-SEQ DATA</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-wrangling-scrnaseq-1" class="section level1">
<h1><span class="header-section-number">4</span> Data Wrangling scRNAseq</h1>
<div id="goal" class="section level2">
<h2><span class="header-section-number">4.1</span> Goal</h2>
<ul>
<li>To give you experience with the analysis of single cell RNA sequencing (scRNA-seq) including performing quality control and identifying cell type subsets.</li>
<li>To introduce you to scRNA-seq analysis using the Seurat package.</li>
</ul>
</div>
<div id="introduction-2" class="section level2">
<h2><span class="header-section-number">4.2</span> Introduction</h2>
<p>Data produced in a single cell RNA-seq experiment has several interesting characteristics that make it distinct from data produced in a bulk population RNA-seq experiment. Two characteristics that are important to keep in mind when working with scRNA-Seq are drop-out (the excessive amount of zeros due to limiting mRNA) and the potential for quality control (QC) metrics to be confounded with biology. This combined with the ability to measure heterogeniety from cells in samples has shifted the field away from the typical analysis in population-based RNA-Seq. Here we demonstrate some approaches to quality control, followed by identifying and analyzing cell subsets.</p>
<p>For this tutorial, we will be analyzing the a dataset of Non-Small Cell Lung Cancer Cells (NSCLC) freely available from 10X Genomics (<a href="https://support.10xgenomics.com/single-cell-vdj/datasets/2.2.0/vdj_v1_hs_nsclc_5gex" class="uri">https://support.10xgenomics.com/single-cell-vdj/datasets/2.2.0/vdj_v1_hs_nsclc_5gex</a>), using the Seurat R package (<a href="http://satijalab.org/seurat/" class="uri">http://satijalab.org/seurat/</a>), a popular and powerful set of tools to conduct scRNA-seq analysis in R. In this dataset, there are 7802 single cells that were sequenced on the Illumina NovaSeq 6000. Please note this tutorial borrows heavily from Seurat’s tutorials, so feel free to go through them in more detail.</p>
<div id="load-necessary-packages" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Load necessary packages</h3>
<p>When loading libraries, we are asking R to load code for us written by someone else. It is a convenient way to leverage and reproduce methodology developed by others.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(Seurat)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">library</span>(Matrix)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">library</span>(gdata)</a></code></pre></div>
</div>
<div id="read-in-nsclc-counts-matrix." class="section level3">
<h3><span class="header-section-number">4.2.2</span> Read in NSCLC counts matrix.</h3>
<p>The data for Non-Small Cell Lung Cancer Cells (NSCLC) is freely available from 10X Genomics (<a href="https://support.10xgenomics.com/single-cell-vdj/datasets/2.2.0/vdj_v1_hs_nsclc_5gex" class="uri">https://support.10xgenomics.com/single-cell-vdj/datasets/2.2.0/vdj_v1_hs_nsclc_5gex</a>). We start by reading in the counts matrix generated by the Cell Ranger count program.</p>
<p>Task: Change the directory name to mydir/ where you saved your data</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">dirname &lt;-<span class="st"> &quot;/Users/kgosik/Documents/data/cellranger/pbmc3k/&quot;</span></a>
<a class="sourceLine" id="cb2-2" title="2">counts_matrix_filename =<span class="st"> </span><span class="kw">paste0</span>(dirname,<span class="st">&quot;/filtered_gene_bc_matrices/hg19/&quot;</span>)</a>
<a class="sourceLine" id="cb2-3" title="3">counts &lt;-<span class="st"> </span><span class="kw">Read10X</span>(<span class="dt">data.dir =</span> counts_matrix_filename)  <span class="co"># Seurat function to read in 10x count data</span></a>
<a class="sourceLine" id="cb2-4" title="4"></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="co"># To minimize memory use on the docker - choose only the first 1000 cells</span></a>
<a class="sourceLine" id="cb2-6" title="6">counts &lt;-<span class="st"> </span>counts[,<span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>]</a></code></pre></div>
</div>
<div id="lets-examine-the-sparse-counts-matrix" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Let’s examine the sparse counts matrix</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">counts[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</a></code></pre></div>
<pre><code>## 10 x 3 sparse Matrix of class &quot;dgCMatrix&quot;
##               AAACATACAACCAC AAACATTGAGCTAC AAACATTGATCAGC
## MIR1302-10                 .              .              .
## FAM138A                    .              .              .
## OR4F5                      .              .              .
## RP11-34P13.7               .              .              .
## RP11-34P13.8               .              .              .
## AL627309.1                 .              .              .
## RP11-34P13.14              .              .              .
## RP11-34P13.9               .              .              .
## AP006222.2                 .              .              .
## RP4-669L17.10              .              .              .</code></pre>
<p>Here we see the upper left corner of the sparse matrix. The columns are indexed by 10x cell barcodes (each 16 nt long), and the rows are the gene names. We mentioned these matrices are sparse, here we see only zeroes (indicated by the “.” symbol); this is the most common value in these sparse matrices. Next, let us look at the dimensions of this matrix.</p>
</div>
<div id="how-big-is-the-matrix" class="section level3">
<h3><span class="header-section-number">4.2.4</span> How big is the matrix?</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">dim</span>(counts) <span class="co"># report number of genes (rows) and number of cells (columns)</span></a></code></pre></div>
<pre><code>## [1] 32738  1000</code></pre>
<p>Here we see the counts matrix has 33694 genes and 7802 cells.</p>
</div>
<div id="how-much-memory-does-a-sparse-matrix-take-up-relative-to-a-dense-matrix" class="section level3">
<h3><span class="header-section-number">4.2.5</span> How much memory does a sparse matrix take up relative to a dense matrix?</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">object.size</span>(counts) <span class="co"># size in bytes</span></a></code></pre></div>
<pre><code>## [1] 12451520 bytes</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">object.size</span>(<span class="kw">as.matrix</span>(counts)) <span class="co"># size in bytes</span></a></code></pre></div>
<pre><code>## [1] 264189072 bytes</code></pre>
<p>We see here that the sparse matrix takes 225 Mb in memory while storing the matrix in a dense format (where all count values including zeros are stored) takes almost 10 times as much memory! This memory saving is very important, especially as data sets are now being created that are beyond a million cells. These matrices can become unmanageable without special computing resources.</p>
<p>In the sparse representation, we assume that the majority of count values in a matrix are zero. We only store the non-zero values. This is implemented in the Matrix package using a dgTMatrix object.</p>
</div>
</div>
<div id="filtering-low-quality-cells" class="section level2">
<h2><span class="header-section-number">4.3</span> Filtering low-quality cells</h2>
<p>You can learn a lot about your scRNA-seq data’s quality with simple plotting. Let’s do some plotting to look at the number of reads per cell, reads per genes, expressed genes per cell (often called complexity), and rarity of genes (cells expressing genes).</p>
<div id="look-at-the-summary-counts-for-genes-and-cells" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Look at the summary counts for genes and cells</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">counts_per_cell &lt;-<span class="st"> </span>Matrix<span class="op">::</span><span class="kw">colSums</span>(counts)</a>
<a class="sourceLine" id="cb11-2" title="2">counts_per_gene &lt;-<span class="st"> </span>Matrix<span class="op">::</span><span class="kw">rowSums</span>(counts)</a>
<a class="sourceLine" id="cb11-3" title="3">genes_per_cell &lt;-<span class="st"> </span>Matrix<span class="op">::</span><span class="kw">colSums</span>(counts <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="co"># count gene only if it has non-zero reads mapped.</span></a></code></pre></div>
<p>Task: In a similar way, can you calculate cells per genes? replace the ‘?’ in the command below</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="co">#### cells_per_gene &lt;- Matrix::?(counts&gt;?) # only count cells where the gene is expressed</span></a>
<a class="sourceLine" id="cb12-2" title="2">cells_per_gene &lt;-<span class="st"> </span>Matrix<span class="op">::</span><span class="kw">rowSums</span>(counts<span class="op">&gt;</span><span class="dv">0</span>) <span class="co"># only count cells where the gene is expressed</span></a></code></pre></div>
<p>colSums and rowSums are functions that work on each row or column in a matrix and return the column sums or row sums as a vector. If this is true counts_per_cell should have 1 entry per cell. Let’s make sure the length of the returned vector matches the matrix dimension for column. How would you do that? ( Hint:length() ).</p>
<p>Notes:
1. Matrix::colSums is a way to force functions from the Matrix library to be used. There are many libraries that implement colSums, we are forcing the one from the Matrix library to be used here to make sure it handles the dgTmatrix (sparse matrix) correctly. This is good practice.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">hist</span>(<span class="kw">log10</span>(counts_per_cell<span class="op">+</span><span class="dv">1</span>),<span class="dt">main=</span><span class="st">&#39;counts per cell&#39;</span>,<span class="dt">col=</span><span class="st">&#39;wheat&#39;</span>)</a></code></pre></div>
<p><img src="KrumlovSingleCellWorkshop2020_files/figure-html/plot_counts-1.png" width="672" /></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">hist</span>(<span class="kw">log10</span>(genes_per_cell<span class="op">+</span><span class="dv">1</span>), <span class="dt">main=</span><span class="st">&#39;genes per cell&#39;</span>, <span class="dt">col=</span><span class="st">&#39;wheat&#39;</span>)</a></code></pre></div>
<p><img src="KrumlovSingleCellWorkshop2020_files/figure-html/plot_counts-2.png" width="672" /></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">plot</span>(counts_per_cell, genes_per_cell, <span class="dt">log=</span><span class="st">&#39;xy&#39;</span>, <span class="dt">col=</span><span class="st">&#39;wheat&#39;</span>)</a>
<a class="sourceLine" id="cb15-2" title="2"><span class="kw">title</span>(<span class="st">&#39;counts vs genes per cell&#39;</span>)</a></code></pre></div>
<p><img src="KrumlovSingleCellWorkshop2020_files/figure-html/plot_counts-3.png" width="672" /></p>
<p>Here we see examples of plotting a new plot, the histogram. R makes this really easy with the hist function. We are also transforming the values to log10 before plotting, this is done with the log10 method. When logging count data, the + 1 is used to avoid log10(0) which is not defined.</p>
<p>Can you make a histogram of counts per gene in log10 scale?</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">hist</span>(<span class="kw">log10</span>(counts_per_gene<span class="op">+</span><span class="dv">1</span>), <span class="dt">main=</span><span class="st">&#39;counts per gene&#39;</span>, <span class="dt">col=</span><span class="st">&#39;wheat&#39;</span>)</a></code></pre></div>
<p><img src="KrumlovSingleCellWorkshop2020_files/figure-html/hist_genes-1.png" width="672" /></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="co">### hist(?(?+1), main=&#39;counts per gene&#39;, col=&#39;wheat&#39;)</span></a></code></pre></div>
</div>
<div id="plot-cells-ranked-by-their-number-of-detected-genes." class="section level3">
<h3><span class="header-section-number">4.3.2</span> Plot cells ranked by their number of detected genes.</h3>
<p>Here we rank each cell by its library complexity, ie the number of genes detected per cell. This is a very useful plot as it shows the distribution of library complexity in the sequencing run. One can use this plot to investigate observations (potential cells) that are actually failed libraries (lower end outliers) or observations that are cell doublets (higher end outliers).</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">plot</span>(<span class="kw">sort</span>(genes_per_cell), <span class="dt">xlab=</span><span class="st">&#39;cell&#39;</span>, <span class="dt">log=</span><span class="st">&#39;y&#39;</span>, <span class="dt">main=</span><span class="st">&#39;genes per cell (ordered)&#39;</span>)</a></code></pre></div>
<p><img src="KrumlovSingleCellWorkshop2020_files/figure-html/rank_cells-1.png" width="672" /></p>
</div>
</div>
<div id="beginning-with-seurat-httpsatijalab.orgseurat" class="section level2">
<h2><span class="header-section-number">4.4</span> Beginning with Seurat: <a href="http://satijalab.org/seurat/" class="uri">http://satijalab.org/seurat/</a></h2>
<div id="creating-a-seurat-object" class="section level3">
<h3><span class="header-section-number">4.4.1</span> Creating a seurat object</h3>
<p>To analyze our single cell data we will use a seurat object. Can you create an Seurat object with the 10x data and save it in an object called ‘seurat’? hint: CreateSeuratObject().
Can you include only genes that are are expressed in 3 or more cells and cells with complexity of 350 genes or more?
How many genes are you left with? How many cells?</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="co">### seurat&lt;-CreateSeuratObject(raw.data = counts, ? = 3, ? = 350, project = &quot;10X_NSCLC&quot;)</span></a>
<a class="sourceLine" id="cb19-2" title="2">seurat &lt;-<span class="st"> </span><span class="kw">CreateSeuratObject</span>(<span class="dt">counts =</span> counts, <span class="dt">min.cells =</span> <span class="dv">3</span>, <span class="dt">min.features =</span> <span class="dv">350</span>, <span class="dt">project =</span> <span class="st">&quot;10X_NSCLC&quot;</span>)</a></code></pre></div>
<p>Almost all our analysis will be on the single object, of class Seurat. This object contains various “slots” (designated by <a href="mailto:seurat@slotname" class="email">seurat@slotname</a>) that will store not only the raw count data, but also the results from various computations below. This has the advantage that we do not need to keep track of inidividual variables of interest - they can all be collapsed into a single object as long as these slots are pre-defined.</p>
<p><code>seurat@raw.data</code> is a slot that stores the original gene count matrix. We can view the first 10 rows (genes) and the first 10 columns (cells).</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">seurat<span class="op">@</span>assays<span class="op">$</span>RNA<span class="op">@</span>counts[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]</a></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="kw">str</span>(seurat)</a></code></pre></div>
<pre><code>## Formal class &#39;Seurat&#39; [package &quot;Seurat&quot;] with 12 slots
##   ..@ assays      :List of 1
##   .. ..$ RNA:Formal class &#39;Assay&#39; [package &quot;Seurat&quot;] with 7 slots
##   .. .. .. ..@ counts       :Formal class &#39;dgCMatrix&#39; [package &quot;Matrix&quot;] with 6 slots
##   .. .. .. .. .. ..@ i       : int [1:838799] 20 59 64 119 132 150 152 182 184 185 ...
##   .. .. .. .. .. ..@ p       : int [1:988] 0 779 2127 3253 4211 4732 5512 6292 7081 7612 ...
##   .. .. .. .. .. ..@ Dim     : int [1:2] 11766 987
##   .. .. .. .. .. ..@ Dimnames:List of 2
##   .. .. .. .. .. .. ..$ : chr [1:11766] &quot;LINC00115&quot; &quot;NOC2L&quot; &quot;KLHL17&quot; &quot;PLEKHN1&quot; ...
##   .. .. .. .. .. .. ..$ : chr [1:987] &quot;AAACATACAACCAC&quot; &quot;AAACATTGAGCTAC&quot; &quot;AAACATTGATCAGC&quot; &quot;AAACCGTGCTTCCG&quot; ...
##   .. .. .. .. .. ..@ x       : num [1:838799] 1 1 2 1 1 1 1 41 1 1 ...
##   .. .. .. .. .. ..@ factors : list()
##   .. .. .. ..@ data         :Formal class &#39;dgCMatrix&#39; [package &quot;Matrix&quot;] with 6 slots
##   .. .. .. .. .. ..@ i       : int [1:838799] 20 59 64 119 132 150 152 182 184 185 ...
##   .. .. .. .. .. ..@ p       : int [1:988] 0 779 2127 3253 4211 4732 5512 6292 7081 7612 ...
##   .. .. .. .. .. ..@ Dim     : int [1:2] 11766 987
##   .. .. .. .. .. ..@ Dimnames:List of 2
##   .. .. .. .. .. .. ..$ : chr [1:11766] &quot;LINC00115&quot; &quot;NOC2L&quot; &quot;KLHL17&quot; &quot;PLEKHN1&quot; ...
##   .. .. .. .. .. .. ..$ : chr [1:987] &quot;AAACATACAACCAC&quot; &quot;AAACATTGAGCTAC&quot; &quot;AAACATTGATCAGC&quot; &quot;AAACCGTGCTTCCG&quot; ...
##   .. .. .. .. .. ..@ x       : num [1:838799] 1 1 2 1 1 1 1 41 1 1 ...
##   .. .. .. .. .. ..@ factors : list()
##   .. .. .. ..@ scale.data   : num[0 , 0 ] 
##   .. .. .. ..@ key          : chr &quot;rna_&quot;
##   .. .. .. ..@ var.features : logi(0) 
##   .. .. .. ..@ meta.features:&#39;data.frame&#39;:   11766 obs. of  0 variables
##   .. .. .. ..@ misc         : NULL
##   ..@ meta.data   :&#39;data.frame&#39;: 987 obs. of  3 variables:
##   .. ..$ orig.ident  : Factor w/ 1 level &quot;10X_NSCLC&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..$ nCount_RNA  : num [1:987] 2419 4898 3144 2637 980 ...
##   .. ..$ nFeature_RNA: int [1:987] 779 1348 1126 958 521 780 780 789 531 550 ...
##   ..@ active.assay: chr &quot;RNA&quot;
##   ..@ active.ident: Factor w/ 1 level &quot;10X_NSCLC&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..- attr(*, &quot;names&quot;)= chr [1:987] &quot;AAACATACAACCAC&quot; &quot;AAACATTGAGCTAC&quot; &quot;AAACATTGATCAGC&quot; &quot;AAACCGTGCTTCCG&quot; ...
##   ..@ graphs      : list()
##   ..@ neighbors   : list()
##   ..@ reductions  : list()
##   ..@ project.name: chr &quot;10X_NSCLC&quot;
##   ..@ misc        : list()
##   ..@ version     :Classes &#39;package_version&#39;, &#39;numeric_version&#39;  hidden list of 1
##   .. ..$ : int [1:3] 3 1 1
##   ..@ commands    : list()
##   ..@ tools       : list()</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="kw">ls</span>(<span class="st">&quot;package:Seurat&quot;</span>)</a></code></pre></div>
<pre><code>##   [1] &quot;AddMetaData&quot;                     &quot;AddModuleScore&quot;                 
##   [3] &quot;ALRAChooseKPlot&quot;                 &quot;as.CellDataSet&quot;                 
##   [5] &quot;as.Graph&quot;                        &quot;as.loom&quot;                        
##   [7] &quot;as.Seurat&quot;                       &quot;as.SingleCellExperiment&quot;        
##   [9] &quot;as.sparse&quot;                       &quot;Assays&quot;                         
##  [11] &quot;AugmentPlot&quot;                     &quot;AverageExpression&quot;              
##  [13] &quot;BarcodeInflectionsPlot&quot;          &quot;BlackAndWhite&quot;                  
##  [15] &quot;BlueAndRed&quot;                      &quot;BoldTitle&quot;                      
##  [17] &quot;BuildClusterTree&quot;                &quot;CalculateBarcodeInflections&quot;    
##  [19] &quot;CaseMatch&quot;                       &quot;cc.genes&quot;                       
##  [21] &quot;cc.genes.updated.2019&quot;           &quot;CellCycleScoring&quot;               
##  [23] &quot;Cells&quot;                           &quot;CellScatter&quot;                    
##  [25] &quot;CellSelector&quot;                    &quot;CollapseEmbeddingOutliers&quot;      
##  [27] &quot;CollapseSpeciesExpressionMatrix&quot; &quot;ColorDimSplit&quot;                  
##  [29] &quot;CombinePlots&quot;                    &quot;Command&quot;                        
##  [31] &quot;CreateAssayObject&quot;               &quot;CreateDimReducObject&quot;           
##  [33] &quot;CreateGeneActivityMatrix&quot;        &quot;CreateSeuratObject&quot;             
##  [35] &quot;CustomDistance&quot;                  &quot;CustomPalette&quot;                  
##  [37] &quot;DarkTheme&quot;                       &quot;DefaultAssay&quot;                   
##  [39] &quot;DefaultAssay&lt;-&quot;                  &quot;DietSeurat&quot;                     
##  [41] &quot;DimHeatmap&quot;                      &quot;DimPlot&quot;                        
##  [43] &quot;DoHeatmap&quot;                       &quot;DotPlot&quot;                        
##  [45] &quot;ElbowPlot&quot;                       &quot;Embeddings&quot;                     
##  [47] &quot;ExpMean&quot;                         &quot;ExportToCellbrowser&quot;            
##  [49] &quot;ExpSD&quot;                           &quot;ExpVar&quot;                         
##  [51] &quot;FeatureLocator&quot;                  &quot;FeaturePlot&quot;                    
##  [53] &quot;FeatureScatter&quot;                  &quot;FetchData&quot;                      
##  [55] &quot;FindAllMarkers&quot;                  &quot;FindClusters&quot;                   
##  [57] &quot;FindConservedMarkers&quot;            &quot;FindIntegrationAnchors&quot;         
##  [59] &quot;FindMarkers&quot;                     &quot;FindNeighbors&quot;                  
##  [61] &quot;FindTransferAnchors&quot;             &quot;FindVariableFeatures&quot;           
##  [63] &quot;FontSize&quot;                        &quot;GeneSymbolThesarus&quot;             
##  [65] &quot;GetAssay&quot;                        &quot;GetAssayData&quot;                   
##  [67] &quot;GetIntegrationData&quot;              &quot;GetResidual&quot;                    
##  [69] &quot;HoverLocator&quot;                    &quot;HTODemux&quot;                       
##  [71] &quot;HTOHeatmap&quot;                      &quot;HVFInfo&quot;                        
##  [73] &quot;Idents&quot;                          &quot;Idents&lt;-&quot;                       
##  [75] &quot;IntegrateData&quot;                   &quot;JackStraw&quot;                      
##  [77] &quot;JackStrawPlot&quot;                   &quot;JS&quot;                             
##  [79] &quot;JS&lt;-&quot;                            &quot;Key&quot;                            
##  [81] &quot;Key&lt;-&quot;                           &quot;L2CCA&quot;                          
##  [83] &quot;L2Dim&quot;                           &quot;LabelClusters&quot;                  
##  [85] &quot;LabelPoints&quot;                     &quot;Loadings&quot;                       
##  [87] &quot;Loadings&lt;-&quot;                      &quot;LocalStruct&quot;                    
##  [89] &quot;LogNormalize&quot;                    &quot;LogSeuratCommand&quot;               
##  [91] &quot;LogVMR&quot;                          &quot;MetaFeature&quot;                    
##  [93] &quot;MinMax&quot;                          &quot;Misc&quot;                           
##  [95] &quot;Misc&lt;-&quot;                          &quot;MixingMetric&quot;                   
##  [97] &quot;MULTIseqDemux&quot;                   &quot;NoAxes&quot;                         
##  [99] &quot;NoGrid&quot;                          &quot;NoLegend&quot;                       
## [101] &quot;NormalizeData&quot;                   &quot;OldWhichCells&quot;                  
## [103] &quot;pbmc_small&quot;                      &quot;PCAPlot&quot;                        
## [105] &quot;PCASigGenes&quot;                     &quot;PCHeatmap&quot;                      
## [107] &quot;PercentageFeatureSet&quot;            &quot;PlotClusterTree&quot;                
## [109] &quot;PolyDimPlot&quot;                     &quot;PolyFeaturePlot&quot;                
## [111] &quot;PrepSCTIntegration&quot;              &quot;Project&quot;                        
## [113] &quot;Project&lt;-&quot;                       &quot;ProjectDim&quot;                     
## [115] &quot;PurpleAndYellow&quot;                 &quot;Read10X&quot;                        
## [117] &quot;Read10X_h5&quot;                      &quot;ReadAlevin&quot;                     
## [119] &quot;ReadAlevinCsv&quot;                   &quot;ReadH5AD&quot;                       
## [121] &quot;Reductions&quot;                      &quot;RegroupIdents&quot;                  
## [123] &quot;RelativeCounts&quot;                  &quot;RenameCells&quot;                    
## [125] &quot;RenameIdents&quot;                    &quot;ReorderIdent&quot;                   
## [127] &quot;RestoreLegend&quot;                   &quot;RidgePlot&quot;                      
## [129] &quot;RotatedAxis&quot;                     &quot;RunALRA&quot;                        
## [131] &quot;RunCCA&quot;                          &quot;RunICA&quot;                         
## [133] &quot;RunLSI&quot;                          &quot;RunPCA&quot;                         
## [135] &quot;RunTSNE&quot;                         &quot;RunUMAP&quot;                        
## [137] &quot;SampleUMI&quot;                       &quot;ScaleData&quot;                      
## [139] &quot;ScoreJackStraw&quot;                  &quot;SCTransform&quot;                    
## [141] &quot;SelectIntegrationFeatures&quot;       &quot;SetAssayData&quot;                   
## [143] &quot;SetIdent&quot;                        &quot;SetIntegrationData&quot;             
## [145] &quot;SeuratAxes&quot;                      &quot;SeuratTheme&quot;                    
## [147] &quot;SpatialTheme&quot;                    &quot;SplitObject&quot;                    
## [149] &quot;StashIdent&quot;                      &quot;Stdev&quot;                          
## [151] &quot;StopCellbrowser&quot;                 &quot;SubsetByBarcodeInflections&quot;     
## [153] &quot;SubsetData&quot;                      &quot;TF.IDF&quot;                         
## [155] &quot;Tool&quot;                            &quot;Tool&lt;-&quot;                         
## [157] &quot;TopCells&quot;                        &quot;TopFeatures&quot;                    
## [159] &quot;TransferData&quot;                    &quot;TSNEPlot&quot;                       
## [161] &quot;UMAPPlot&quot;                        &quot;UpdateSeuratObject&quot;             
## [163] &quot;UpdateSymbolList&quot;                &quot;VariableFeaturePlot&quot;            
## [165] &quot;VariableFeatures&quot;                &quot;VariableFeatures&lt;-&quot;             
## [167] &quot;VizDimLoadings&quot;                  &quot;VlnPlot&quot;                        
## [169] &quot;WhichCells&quot;                      &quot;WhiteBackground&quot;</code></pre>
</div>
</div>
<div id="preprocessing-step-1-filter-out-low-quality-cells" class="section level2">
<h2><span class="header-section-number">4.5</span> Preprocessing step 1 : Filter out low-quality cells</h2>
<p>The Seurat object initialization step above only considered cells that expressed at least 350 genes. Additionally, we would like to exclude cells that are damaged. A common metric to judge this (although by no means the only one) is the relative expression of mitochondrially derived genes. When the cells apoptose due to stress, their mitochondria becomes leaky and there is widespread RNA degradation. Thus a relative enrichment of mitochondrially derived genes can be a tell-tale sign of cell stress. Here, we compute the proportion of transcripts that are of mitochondrial origin for every cell (<code>percent.mito</code>), and visualize its distribution as a violin plot. We also use the <code>GenePlot</code> function to observe how <code>percent.mito</code> correlates with other metrics.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1"><span class="co"># The number of genes and UMIs (nGene and nUMI) are automatically calculated</span></a>
<a class="sourceLine" id="cb25-2" title="2"><span class="co"># for every object by Seurat.  For non-UMI data, nUMI represents the sum of</span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="co"># the non-normalized values within a cell We calculate the percentage of</span></a>
<a class="sourceLine" id="cb25-4" title="4"><span class="co"># mitochondrial genes here and store it in percent.mito using AddMetaData.</span></a>
<a class="sourceLine" id="cb25-5" title="5"><span class="co"># We use object@raw.data since this represents non-transformed and</span></a>
<a class="sourceLine" id="cb25-6" title="6"><span class="co"># non-log-normalized counts The % of UMI mapping to MT-genes is a common</span></a>
<a class="sourceLine" id="cb25-7" title="7"><span class="co"># scRNA-seq QC metric.</span></a>
<a class="sourceLine" id="cb25-8" title="8"></a>
<a class="sourceLine" id="cb25-9" title="9"></a>
<a class="sourceLine" id="cb25-10" title="10"><span class="co"># The [[ operator can add columns to object metadata. This is a great place to stash QC stats</span></a>
<a class="sourceLine" id="cb25-11" title="11">seurat[[<span class="st">&quot;percent.mt&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">PercentageFeatureSet</span>(<span class="dt">object =</span> seurat, <span class="dt">pattern =</span> <span class="st">&quot;^MT-&quot;</span>)</a>
<a class="sourceLine" id="cb25-12" title="12"></a>
<a class="sourceLine" id="cb25-13" title="13"><span class="co"># AddMetaData adds columns to object@meta.data, and is a great place to stash QC stats.</span></a>
<a class="sourceLine" id="cb25-14" title="14"><span class="co"># This also allows us to plot the metadata values using the Seurat&#39;s VlnPlot().</span></a>
<a class="sourceLine" id="cb25-15" title="15"><span class="kw">head</span>(seurat<span class="op">@</span>meta.data) <span class="co"># Before adding</span></a></code></pre></div>
<pre><code>##                orig.ident nCount_RNA nFeature_RNA percent.mt
## AAACATACAACCAC  10X_NSCLC       2419          779  3.0177759
## AAACATTGAGCTAC  10X_NSCLC       4898         1348  3.7974684
## AAACATTGATCAGC  10X_NSCLC       3144         1126  0.8905852
## AAACCGTGCTTCCG  10X_NSCLC       2637          958  1.7444065
## AAACCGTGTATGCG  10X_NSCLC        980          521  1.2244898
## AAACGCACTGGTAC  10X_NSCLC       2162          780  1.6651249</code></pre>
<p>Task: Can add the percentage if mitochondrial genes to the seurat object meta data?
If you dont remember the name of the parameter you can type ?AddMetaData in the console.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1"><span class="kw">VlnPlot</span>(<span class="dt">object =</span> seurat, <span class="dt">features =</span> <span class="kw">c</span>(<span class="st">&quot;nFeature_RNA&quot;</span>, <span class="st">&quot;nCount_RNA&quot;</span>, <span class="st">&quot;percent.mt&quot;</span>), <span class="dt">ncol =</span> <span class="dv">3</span>)</a></code></pre></div>
<p><img src="KrumlovSingleCellWorkshop2020_files/figure-html/vln_plot-1.png" width="672" /></p>
<p>Here we calculated the percent mitochondrial reads and added it to the Seurat object in the slot named meta.data. This allowed us to plot using the violin plot function provided by Seurat.</p>
<p>A third metric we use is the number of house keeping genes expressed in a cell. These genes reflect commomn processes active in a cell and hence are a good global quality measure. They are also abundant and are usually steadliy expressed in cells, thus less sensitive to the high dropout.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1"><span class="co"># Load the the list of house keeping genes</span></a>
<a class="sourceLine" id="cb28-2" title="2">hkgenes &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;/Users/kgosik/Documents/data/tirosh_house_keeping.txt&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb28-3" title="3">hkgenes &lt;-<span class="st"> </span><span class="kw">as.vector</span>(hkgenes<span class="op">$</span>V1)</a>
<a class="sourceLine" id="cb28-4" title="4"></a>
<a class="sourceLine" id="cb28-5" title="5"><span class="co"># remove hkgenes that were not found</span></a>
<a class="sourceLine" id="cb28-6" title="6">hkgenes.found &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">toupper</span>(<span class="kw">rownames</span>(seurat<span class="op">@</span>assays<span class="op">$</span>RNA<span class="op">@</span>data)) <span class="op">%in%</span><span class="st"> </span>hkgenes)</a></code></pre></div>
<p>Possible task: Feel like challenging yourself? write the code to do the following:
1. Sum the number of detected house keeping genes for each cell
2. Add this information as meta data to seurat
3. plot all metrics: “nGene”, “nUMI”, “percent.mito”,“n.exp.hkgenes” using VlnPlot
4. Scroll down to see if you got it!</p>
<p>If you feel like going through a more guided version, scroll down and follow the instructions.</p>
<p>Alternative task: Sum the number of detected house keeping genes for each cell, then add this to the meta data</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1"><span class="co">#### n.expressed.hkgenes &lt;- ?(seurat@data[hkgenes.found, ] &gt; ?)</span></a>
<a class="sourceLine" id="cb29-2" title="2"><span class="co">#### seurat &lt;- AddMetaData(object = ?, ? = ?, col.name = &quot;n.exp.hkgenes&quot;)</span></a>
<a class="sourceLine" id="cb29-3" title="3">n.expressed.hkgenes &lt;-<span class="st"> </span>Matrix<span class="op">::</span><span class="kw">colSums</span>(seurat<span class="op">@</span>assays<span class="op">$</span>RNA<span class="op">@</span>data[hkgenes.found, ] <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb29-4" title="4">seurat &lt;-<span class="st"> </span><span class="kw">AddMetaData</span>(<span class="dt">object =</span> seurat, <span class="dt">metadata =</span> n.expressed.hkgenes, <span class="dt">col.name =</span> <span class="st">&quot;n.exp.hkgenes&quot;</span>)</a>
<a class="sourceLine" id="cb29-5" title="5"><span class="kw">VlnPlot</span>(<span class="dt">object =</span> seurat, <span class="dt">features =</span> <span class="kw">c</span>(<span class="st">&quot;nFeature_RNA&quot;</span>, <span class="st">&quot;nCount_RNA&quot;</span>, <span class="st">&quot;percent.mt&quot;</span>,<span class="st">&quot;n.exp.hkgenes&quot;</span>), <span class="dt">nCol =</span> <span class="dv">4</span>)</a></code></pre></div>
<pre><code>## Warning in as_grob.default(plot): Cannot convert object of class numeric
## into a grob.</code></pre>
<pre><code>## Warning: Graphs cannot be vertically aligned unless the axis parameter is
## set. Placing graphs unaligned.</code></pre>
<pre><code>## Warning: Graphs cannot be horizontally aligned unless the axis parameter is
## set. Placing graphs unaligned.</code></pre>
<p><img src="KrumlovSingleCellWorkshop2020_files/figure-html/Add_number_of_house_keeping_genes-1.png" width="672" /></p>
<p>Is there a correlation between the measurements? For example, number of UMIs with number of genes?
Possible task: Feel like challenging yourself? write the code to do the following:
Can you plot the nGene vs nUMI (hint:GenePlot)? What is the correlation? Do you see a strange subpopulation? What do you think happened with these cells?</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">seurat</a></code></pre></div>
<p>Scroll down to see the command</p>
<p>Alternative task:
Can you plot the nFeature_RNA vs nCount_RNA (hint:FeatureScatter)? What is the correlation? Do you see a strange subpopulation? What do you think happened with these cells?</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1"><span class="co"># FeatureScatter is typically used to visualize feature-feature relationships, but can be used</span></a>
<a class="sourceLine" id="cb34-2" title="2"><span class="co"># for anything calculated by the object, i.e. columns in object metadata, PC scores etc.</span></a>
<a class="sourceLine" id="cb34-3" title="3"></a>
<a class="sourceLine" id="cb34-4" title="4">plot1 &lt;-<span class="st"> </span><span class="kw">FeatureScatter</span>(seurat, <span class="dt">feature1 =</span> <span class="st">&quot;nCount_RNA&quot;</span>, <span class="dt">feature2 =</span> <span class="st">&quot;percent.mt&quot;</span>)</a>
<a class="sourceLine" id="cb34-5" title="5">plot2 &lt;-<span class="st"> </span><span class="kw">FeatureScatter</span>(seurat, <span class="dt">feature1 =</span> <span class="st">&quot;nCount_RNA&quot;</span>, <span class="dt">feature2 =</span> <span class="st">&quot;nFeature_RNA&quot;</span>)</a>
<a class="sourceLine" id="cb34-6" title="6"><span class="kw">CombinePlots</span>(<span class="dt">plots =</span> <span class="kw">list</span>(plot1, plot2))</a></code></pre></div>
<p><img src="KrumlovSingleCellWorkshop2020_files/figure-html/alt_task-1.png" width="672" /></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1"><span class="co">### GenePlot(object = seurat, gene1 = ?, gene2 = ?)</span></a>
<a class="sourceLine" id="cb35-2" title="2"><span class="kw">FeatureScatter</span>(<span class="dt">object =</span> seurat, <span class="dt">feature1 =</span> <span class="st">&quot;nCount_RNA&quot;</span>, <span class="dt">feature2 =</span> <span class="st">&quot;nFeature_RNA&quot;</span>)</a></code></pre></div>
</div>
<div id="examine-contents-of-seurat-object" class="section level2">
<h2><span class="header-section-number">4.6</span> Examine contents of Seurat object</h2>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1"><span class="kw">str</span>(seurat)</a></code></pre></div>
<p>These are the slots in the Seurat object. Some of the slots are automatically updated by Seurat as you move through analysis. Take a moment to look through the information, knowing the slots allow you to leverage work Seurat has already done for you.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1"><span class="kw">VlnPlot</span>(<span class="dt">object =</span> seurat, <span class="dt">features =</span> <span class="kw">c</span>(<span class="st">&quot;nFeature_RNA&quot;</span>), <span class="dt">group.by =</span> <span class="kw">c</span>(<span class="st">&#39;orig.ident&#39;</span>))</a></code></pre></div>
<p>Here we plot the number of genes per cell by what Seurat calls orig.ident. Identity is a concept that is used in the Seurat object to refer to the cell identity. In this case, the cell identity is 10X_NSCLC, but after we cluster the cells, the cell identity will be whatever cluster the cell belongs to. We will see how identity updates as we go throught the analysis.</p>
<p>Next, let’s filter the cells based on the quality control metrics.
Filter based on:
1. nGene
2. percent.mito
3. n.exp.hkgenes
Task: Change the thresholds to what you think they should be according to the violin plots</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" title="1"><span class="kw">VlnPlot</span>(<span class="dt">object =</span> seurat, <span class="dt">features =</span> <span class="kw">c</span>(<span class="st">&quot;nFeature_RNA&quot;</span>,<span class="st">&quot;percent.mt&quot;</span>,<span class="st">&quot;n.exp.hkgenes&quot;</span>), <span class="dt">nCol =</span> <span class="dv">3</span>)</a></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1"><span class="co">#### seurat &lt;- FilterCells(object = seurat, subset.names = c(&quot;nGene&quot;, &quot;percent.mito&quot;,&quot;n.exp.hkgenes&quot;), low.thresholds = c(350, -Inf,55), high.thresholds = c(5000, 0.1, Inf))</span></a></code></pre></div>
<p>How many cells are you left with?</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" title="1">seurat</a></code></pre></div>
<div id="preprocessing-step-2-expression-normalization" class="section level3">
<h3><span class="header-section-number">4.6.1</span> Preprocessing step 2 : Expression normalization</h3>
<p>After removing unwanted genes cells from the dataset, the next step is to normalize the data. By default, we employ a global-scaling normalization method “LogNormalize” that normalizes the gene expression measurements for each cell by the total expression, multiplies this by a scale factor (10,000 by default), and log-transforms the result. There have been many methods to normalize the data, but this is the simplest and the most intuitive. The division by total expression is done to change all expression counts to a relative measure, since experience has suggested that technical factors (e.g. capture rate, efficiency of reverse transcription) are largely responsible for the variation in the number of molecules per cell, although genuine biological factors (e.g. cell cycle stage, cell size) also play a smaller, but non-negligible role. The log-transformation is a commonly used transformation that has many desirable properties, such as variance stabilization (can you think of others?).</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" title="1">seurat &lt;-<span class="st"> </span><span class="kw">NormalizeData</span>(<span class="dt">object =</span> seurat, <span class="dt">normalization.method =</span> <span class="st">&quot;LogNormalize&quot;</span>, <span class="dt">scale.factor =</span> <span class="fl">1e4</span>)</a></code></pre></div>
<p>Well there you have it! A filtered and normalized gene-expression data set. A great accomplishment for your first dive into scRNA-Seq analysis. Well done!</p>
</div>
</div>
<div id="detection-of-variable-genes-across-the-single-cells" class="section level2">
<h2><span class="header-section-number">4.7</span> Detection of variable genes across the single cells</h2>
<p>Seurat calculates highly variable genes and focuses on these for downstream analysis. <strong><code>FindVariableGenes</code></strong> calculates the average expression and dispersion for each gene, places these genes into bins, and then calculates a z-score for dispersion within each bin. This helps control for the relationship between variability and average expression. This function is unchanged from (Macosko <em>et al</em>.), but new methods for variable gene expression identification are coming soon. We suggest that users set these parameters to mark visual outliers on the dispersion plot, but the exact parameter settings may vary based on the data type, heterogeneity in the sample, and normalization strategy. The parameters here identify ~3,000 variable genes, and represent typical parameter settings for UMI data that is normalized to a total of 1e4 molecules.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1"><span class="co">#seurat &lt;- FindVariableGenes(object = seurat, mean.function = ExpMean, dispersion.function = LogVMR, x.low.cutoff = 0.0125, x.high.cutoff = 3, y.cutoff = 0.5, num.bin=20)  # if this fails, experiment with the num.bin setting</span></a>
<a class="sourceLine" id="cb42-2" title="2">seurat &lt;-<span class="st"> </span><span class="kw">FindVariableFeatures</span>(<span class="dt">object =</span> seurat, <span class="dt">selection.method =</span> <span class="st">&quot;vst&quot;</span>, <span class="dt">nfeatures =</span> <span class="dv">2000</span>)</a>
<a class="sourceLine" id="cb42-3" title="3"></a>
<a class="sourceLine" id="cb42-4" title="4"><span class="co"># Identify the 10 most highly variable genes</span></a>
<a class="sourceLine" id="cb42-5" title="5">top10 &lt;-<span class="st"> </span><span class="kw">head</span>(<span class="kw">VariableFeatures</span>(seurat), <span class="dv">10</span>)</a></code></pre></div>
<p>We can see the Seurat object slots have updated for the FindVariableGenes section. Let’s use the slot to see how many variable genes we found.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" title="1"><span class="kw">str</span>(seurat)</a>
<a class="sourceLine" id="cb43-2" title="2"><span class="kw">length</span>(<span class="dt">x =</span> seurat<span class="op">@</span>assays<span class="op">$</span>RNA<span class="op">@</span>var.features)</a></code></pre></div>
<p>Task: how does changing the parameters for find variable genes function changes the number of the found genes?
Play with the parameters - what makes the function find more variable genes? less?</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1">seurat &lt;-<span class="st"> </span><span class="kw">FindVariableFeatures</span>(<span class="dt">object =</span> seurat, <span class="dt">mean.function =</span> ExpMean, <span class="dt">dispersion.function =</span> LogVMR, <span class="dt">x.low.cutoff =</span> <span class="fl">0.0125</span>, <span class="dt">x.high.cutoff =</span> <span class="dv">1</span>, <span class="dt">y.cutoff =</span> <span class="fl">0.5</span>, <span class="dt">num.bin=</span><span class="dv">40</span>, <span class="dt">do.plot =</span> <span class="ot">FALSE</span>) </a>
<a class="sourceLine" id="cb44-2" title="2"><span class="kw">length</span>(seurat<span class="op">@</span>assays<span class="op">$</span>RNA<span class="op">@</span>var.features)</a></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" title="1">seurat &lt;-<span class="st"> </span><span class="kw">FindVariableFeatures</span>(<span class="dt">object =</span> seurat, <span class="dt">mean.function =</span> ExpMean, <span class="dt">dispersion.function =</span> LogVMR, <span class="dt">x.low.cutoff =</span> <span class="fl">0.0125</span>, <span class="dt">x.high.cutoff =</span> <span class="dv">1</span>, <span class="dt">y.cutoff =</span> <span class="fl">0.5</span>, <span class="dt">num.bin=</span><span class="dv">10</span>, <span class="dt">do.plot =</span> <span class="ot">FALSE</span>)  </a>
<a class="sourceLine" id="cb45-2" title="2"><span class="kw">length</span>(seurat<span class="op">@</span>assays<span class="op">$</span>RNA<span class="op">@</span>var.features)</a></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" title="1">seurat &lt;-<span class="st"> </span><span class="kw">FindVariableFeatures</span>(<span class="dt">object =</span> seurat, <span class="dt">mean.function =</span> ExpMean, <span class="dt">dispersion.function =</span> LogVMR, <span class="dt">x.low.cutoff =</span> <span class="fl">0.0125</span>, <span class="dt">x.high.cutoff =</span> <span class="dv">1</span>, <span class="dt">y.cutoff =</span> <span class="fl">0.5</span>, <span class="dt">num.bin=</span><span class="dv">20</span>, <span class="dt">do.plot =</span> <span class="ot">FALSE</span>)  </a>
<a class="sourceLine" id="cb46-2" title="2"><span class="kw">length</span>(seurat<span class="op">@</span>assays<span class="op">$</span>RNA<span class="op">@</span>var.features)</a></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" title="1">seurat &lt;-<span class="st"> </span><span class="kw">FindVariableFeatures</span>(<span class="dt">object =</span> seurat, <span class="dt">mean.function =</span> ExpMean, <span class="dt">dispersion.function =</span> LogVMR, <span class="dt">x.low.cutoff =</span> <span class="fl">0.2</span>, <span class="dt">x.high.cutoff =</span> <span class="dv">1</span>, <span class="dt">y.cutoff =</span> <span class="fl">0.5</span>, <span class="dt">num.bin=</span><span class="dv">20</span>, <span class="dt">do.plot =</span> <span class="ot">FALSE</span>)  </a>
<a class="sourceLine" id="cb47-2" title="2"><span class="kw">length</span>(seurat<span class="op">@</span>assays<span class="op">$</span>RNA<span class="op">@</span>var.features)</a></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" title="1">seurat &lt;-<span class="st"> </span><span class="kw">FindVariableFeatures</span>(<span class="dt">object =</span> seurat, <span class="dt">mean.function =</span> ExpMean, <span class="dt">dispersion.function =</span> LogVMR, <span class="dt">x.low.cutoff =</span> <span class="fl">0.0125</span>, <span class="dt">x.high.cutoff =</span> <span class="fl">0.1</span>, <span class="dt">y.cutoff =</span> <span class="fl">0.5</span>, <span class="dt">num.bin=</span><span class="dv">20</span>, <span class="dt">do.plot =</span> <span class="ot">FALSE</span>)  </a>
<a class="sourceLine" id="cb48-2" title="2"><span class="kw">length</span>(seurat<span class="op">@</span>assays<span class="op">$</span>RNA<span class="op">@</span>var.features)</a></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" title="1">seurat &lt;-<span class="st"> </span><span class="kw">FindVariableFeatures</span>(<span class="dt">object =</span> seurat, <span class="dt">mean.function =</span> ExpMean, <span class="dt">dispersion.function =</span> LogVMR, <span class="dt">x.low.cutoff =</span> <span class="fl">0.0125</span>, <span class="dt">x.high.cutoff =</span> <span class="dv">1</span>, <span class="dt">y.cutoff =</span> <span class="dv">2</span>, <span class="dt">num.bin=</span><span class="dv">10</span>, <span class="dt">do.plot =</span> <span class="ot">FALSE</span>)  </a>
<a class="sourceLine" id="cb49-2" title="2"><span class="kw">length</span>(seurat<span class="op">@</span>assays<span class="op">$</span>RNA<span class="op">@</span>var.features)</a></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" title="1"><span class="co"># plot variable features with and without labels</span></a>
<a class="sourceLine" id="cb50-2" title="2">plot1 &lt;-<span class="st"> </span><span class="kw">VariableFeaturePlot</span>(seurat)</a>
<a class="sourceLine" id="cb50-3" title="3">plot2 &lt;-<span class="st"> </span><span class="kw">LabelPoints</span>(<span class="dt">plot =</span> plot1, <span class="dt">points =</span> top10, <span class="dt">repel =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## When using repel, set xnudge and ynudge to 0 for optimal results</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" title="1"><span class="kw">CombinePlots</span>(<span class="dt">plots =</span> <span class="kw">list</span>(plot1, plot2))</a></code></pre></div>
<p><img src="KrumlovSingleCellWorkshop2020_files/figure-html/plot_vargenes-1.png" width="672" /></p>
</div>
<div id="gene-set-expression-across-cells" class="section level2">
<h2><span class="header-section-number">4.8</span> Gene set expression across cells</h2>
<p>Sometimes we want to ask what is the expression of a set of a genes across cells. This set of genes may make up a gene expression program we are interested in. Another benefit at looking at gene sets is it reduces the effects of drop outs.</p>
<p>Below, we look at genes involved in: T cells, the cell cycle and the stress signature upon cell dissociation. We calculate these genes average expression levels on the single cell level, while controlling for technical effects.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" title="1"><span class="co"># Read in a list of cell cycle markers, from Tirosh et al, 2015.</span></a>
<a class="sourceLine" id="cb53-2" title="2"><span class="co"># We can segregate this list into markers of G2/M phase and markers of S phase.</span></a>
<a class="sourceLine" id="cb53-3" title="3">cc.genes &lt;-<span class="st"> </span><span class="kw">readLines</span>(<span class="st">&quot;/Users/kgosik/Documents/data/regev_lab_cell_cycle_genes.txt&quot;</span>)</a>
<a class="sourceLine" id="cb53-4" title="4">s.genes &lt;-<span class="st"> </span>cc.genes[<span class="dv">1</span><span class="op">:</span><span class="dv">43</span>]</a>
<a class="sourceLine" id="cb53-5" title="5">g2m.genes &lt;-<span class="st"> </span>cc.genes[<span class="dv">44</span><span class="op">:</span><span class="dv">97</span>]</a>
<a class="sourceLine" id="cb53-6" title="6"></a>
<a class="sourceLine" id="cb53-7" title="7">seurat &lt;-<span class="st"> </span><span class="kw">CellCycleScoring</span>(<span class="dt">object =</span> seurat, <span class="dt">s.features =</span> s.genes, <span class="dt">g2m.features =</span> g2m.genes, <span class="dt">set.ident =</span> T)</a></code></pre></div>
<p>Task: Use markers for dissociation to calculate dissociation score</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" title="1"><span class="co"># Genes upregulated during dissociation of tissue into single cells.</span></a>
<a class="sourceLine" id="cb54-2" title="2">genes.dissoc &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;ATF3&quot;</span>, <span class="st">&quot;BTG2&quot;</span>, <span class="st">&quot;CEBPB&quot;</span>, <span class="st">&quot;CEBPD&quot;</span>, <span class="st">&quot;CXCL3&quot;</span>, <span class="st">&quot;CXCL2&quot;</span>, <span class="st">&quot;CXCL1&quot;</span>, <span class="st">&quot;DNAJA1&quot;</span>, <span class="st">&quot;DNAJB1&quot;</span>, <span class="st">&quot;DUSP1&quot;</span>, <span class="st">&quot;EGR1&quot;</span>, <span class="st">&quot;FOS&quot;</span>, <span class="st">&quot;FOSB&quot;</span>, <span class="st">&quot;HSP90AA1&quot;</span>, <span class="st">&quot;HSP90AB1&quot;</span>, <span class="st">&quot;HSPA1A&quot;</span>, <span class="st">&quot;HSPA1B&quot;</span>, <span class="st">&quot;HSPA1A&quot;</span>, <span class="st">&quot;HSPA1B&quot;</span>, <span class="st">&quot;HSPA8&quot;</span>, <span class="st">&quot;HSPB1&quot;</span>, <span class="st">&quot;HSPE1&quot;</span>, <span class="st">&quot;HSPH1&quot;</span>, <span class="st">&quot;ID3&quot;</span>, <span class="st">&quot;IER2&quot;</span>, <span class="st">&quot;JUN&quot;</span>, <span class="st">&quot;JUNB&quot;</span>, <span class="st">&quot;JUND&quot;</span>, <span class="st">&quot;MT1X&quot;</span>, <span class="st">&quot;NFKBIA&quot;</span>, <span class="st">&quot;NR4A1&quot;</span>, <span class="st">&quot;PPP1R15A&quot;</span>, <span class="st">&quot;SOCS3&quot;</span>, <span class="st">&quot;ZFP36&quot;</span>)</a>
<a class="sourceLine" id="cb54-3" title="3"><span class="co">#### seurat &lt;- ?(?, genes.list = list(?), ctrl.size = 20, enrich.name = &quot;genes_dissoc&quot;)</span></a>
<a class="sourceLine" id="cb54-4" title="4">seurat &lt;-<span class="st"> </span><span class="kw">AddModuleScore</span>(seurat, <span class="dt">features =</span> <span class="kw">list</span>(genes.dissoc), <span class="dt">ctrl.size =</span> <span class="dv">20</span>, <span class="dt">enrich.name =</span> <span class="st">&quot;genes_dissoc&quot;</span>)</a></code></pre></div>
<p>Task:
Plot the correlation between number of genes and S score.
How do we know the name of these scores in the seurat meta data?</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" title="1"><span class="co">### GenePlot(seurat, &quot;S.Score&quot;, &quot;nGene&quot;)</span></a>
<a class="sourceLine" id="cb55-2" title="2"><span class="kw">FeatureScatter</span>(seurat, <span class="st">&quot;S.Score&quot;</span>, <span class="st">&quot;nFeature_RNA&quot;</span>)</a></code></pre></div>
<p>Bonus: Can you cluster the data based on the variable genes alone?</p>
<p>Congratulations! You can identify and visualize cell subsets and the marker genes that describe these cell subsets. This is a very powerful analysis pattern often seen in publications. Well done!</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="expression-qc-and-normalization-1.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="identifying-cell-populations-1.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["KrumlovSingleCellWorkshop2020.pdf", "KrumlovSingleCellWorkshop2020.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
